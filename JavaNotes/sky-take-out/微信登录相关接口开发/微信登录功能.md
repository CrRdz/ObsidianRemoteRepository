# 需求分析和设计

业务规则
- 基于微信登录实现小程序（用户端）的登录功能
- 如果是新用户需要自动完成注册
## 接口设计
- 基本信息
	- Path:/user/user/login
	- Method:POST
- 请求参数
	Headers

| 参数名称         | 参数值              | 是否必须 | 示例  | 备注  |
| ------------ | ---------------- | ---- | --- | --- |
| Content-Type | application/json | 是    |     |     |
	Body
	
| 名称   | 类型     | 是否必须 | 默认值 | 备注      | 其他信息 |
| ---- | ------ | ---- | --- | ------- | ---- |
| code | string | 必须   |     | 微信用户授权码 |      |
- 返回数据

| 名称        | 类型      | 是否必须 | 默认值 | 备注       | 其他信息         |
| --------- | ------- | ---- | --- | -------- | ------------ |
| code      | integer | 必须   |     |          | format：int32 |
| data      | object  | 必须   |     |          |              |
| ├─ id     | integer | 必须   |     | 用户id     | format：int64 |
| ├─ openid | string  | 必须   |     | 微信openid |              |
| ├─ token  | string  | 必须   |     | jwt令牌    |              |
| msg       | string  | 非必须  |     |          |              |
# 数据库设计
[[数据库设计文档#^72b20a|user表]]
# 代码开发

# `UserController`

```java
@RestController  
@RequestMapping("/user/user")  
@Api(tags = "C端用户信息相关接口")  
@Slf4j  
public class UserController {  
  
    @Autowired  
    private UserService userService;  
  
    @Autowired  
    private JwtProperties jwtProperties;  
  
    @PostMapping("/login")  
    @ApiOperation("微信登录")  
    public Result<UserLoginVO> login(@RequestBody UserLoginDTO userLoginDTO) {  
        log.info("微信登录，userLoginDTO：{}", userLoginDTO.getCode());  
  
        // 调用service层微信登录方法  
        User user = userService.wxLogin(userLoginDTO);  
  
        // 为微信用户生成token，返回给前端  
        Map<String, Object> claims = new HashMap<>();  
        claims.put(JwtClaimsConstant.USER_ID, user.getId());  
        String token = JwtUtil.createJWT(jwtProperties.getUserSecretKey(), jwtProperties.getUserTtl(), claims);  
  
        UserLoginVO userLoginVO = UserLoginVO.builder()  
                .id(user.getId())  
                .openid(user.getOpenid())  
                .token(token)  
                .build();  
        return Result.success(userLoginVO);  
  
    }  
}
```