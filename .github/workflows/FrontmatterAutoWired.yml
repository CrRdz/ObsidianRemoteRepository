name: Frontmatter AutoWired

on:
  push:
    branches:
      - master
    paths:
      - '**.md'

jobs:
  add-frontmatter:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master  # ğŸ”§ ç¡®ä¿åŸºäºæœ€æ–° master
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install openai
      
      # ğŸ”§ è·å– PR ä¸­å·²å¤„ç†çš„æ–‡ä»¶
      - name: Get existing PR files
        id: pr_files
        run: |
          PR_NUMBER=$(gh pr list --head frontmatter-auto-update --base master --state open --json number --jq '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "Found open PR #$PR_NUMBER"
            
            # è·å– PR ä¸­æ‰€æœ‰å˜æ›´çš„æ–‡ä»¶
            PR_FILES=$(gh pr diff $PR_NUMBER --name-only | grep '\.md$' || echo "")
            
            if [ -n "$PR_FILES" ]; then
              echo "Files already in PR:"
              echo "$PR_FILES" | sed 's/^/  - /'
              
              echo "PR_MODIFIED_FILES<<EOF" >> $GITHUB_ENV
              echo "$PR_FILES" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
              
              echo "has_existing_pr=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "No open PR found"
            echo "has_existing_pr=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # ğŸ”§ å¦‚æœ PR å·²å­˜åœ¨,å…ˆæ‹‰å– PR åˆ†æ”¯çš„å†…å®¹
      - name: Merge PR branch changes
        if: steps.pr_files.outputs.has_existing_pr == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ‹‰å– PR åˆ†æ”¯
          git fetch origin frontmatter-auto-update
          
          # åˆ›å»ºä¸´æ—¶åˆ†æ”¯åˆå¹¶ PR çš„ä¿®æ”¹
          git checkout -b temp-merge
          git merge origin/frontmatter-auto-update --no-commit --no-ff || true
          
          # åº”ç”¨ PR åˆ†æ”¯çš„æ–‡ä»¶ä¿®æ”¹åˆ°å½“å‰å·¥ä½œåŒº
          git checkout origin/frontmatter-auto-update -- '*.md' 2>/dev/null || true
          
          # å›åˆ° master
          git checkout master
          
          # å¤åˆ¶å·²å¤„ç†çš„æ–‡ä»¶
          if [ -n "$PR_MODIFIED_FILES" ]; then
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                git checkout temp-merge -- "$file" 2>/dev/null || true
                echo "  âœ“ Restored from PR: $file"
              fi
            done <<< "$PR_MODIFIED_FILES"
          fi
          
          git branch -D temp-merge 2>/dev/null || true
        env:
          PR_MODIFIED_FILES: ${{ env.PR_MODIFIED_FILES }}
      
      - name: Run Frontmatter AutoWired
        env:
          OPENAI_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python .github/scripts/frontmatter_autowired.py
      
      - name: Get file info
        id: info
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD | grep '\.md$' || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            # æ£€æŸ¥æœªè¿½è¸ªçš„æ–‡ä»¶
            CHANGED_FILES=$(git ls-files --others --exclude-standard | grep '\.md$' || echo "")
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            FILE_LIST=""
            while IFS= read -r file; do
              FILE_LIST="${FILE_LIST}- \`${file}\`\n"
            done <<< "$CHANGED_FILES"
            
            echo "file_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "Changed files:"
            echo "$CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi
      
      - name: Create or Update Pull Request
        if: steps.info.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: frontmatter-auto-update
          delete-branch: false
          base: master
          
          # ğŸ”§ å…³é”®: è¿½åŠ æ¨¡å¼,ä¸é‡ç½®åˆ†æ”¯
          commit-message: |
            chore: auto-add frontmatter for ${{ steps.info.outputs.file_count }} file(s)
            
            Trigger: ${{ github.sha }}
            
          title: 'Frontmatter è‡ªåŠ¨æ›´æ–°'
          
          # ğŸ”§ æ›´æ–° PR body æ˜¾ç¤ºç´¯è®¡ä¿¡æ¯
          body: |
            ## æ¦‚è¿°
            
            æœ¬ PR ä½¿ç”¨ AI è‡ªåŠ¨ä¸º Markdown æ–‡ä»¶ç”Ÿæˆæˆ–æ›´æ–° frontmatter å…ƒæ•°æ®ã€‚
            
            **æ³¨æ„:** æœ¬ PR é‡‡ç”¨æŒç»­æ›´æ–°æ¨¡å¼ã€‚æ¯æ¬¡å‘ master åˆ†æ”¯æ¨é€æ—¶,æ–°çš„å˜æ›´ä¼šè‡ªåŠ¨è¿½åŠ åˆ°æ­¤ PR,ç›´åˆ°åˆå¹¶ä¸ºæ­¢ã€‚
            
            ---
            
            ## æœ¬æ¬¡æ¨é€å˜æ›´
            
            **æœ¬æ¬¡ä¿®æ”¹æ–‡ä»¶æ•°:** ${{ steps.info.outputs.file_count }}
            
            ${{ steps.info.outputs.file_list }}
            
            ---
            
            ## å®¡é˜…æ£€æŸ¥é¡¹
            
            åˆå¹¶å‰è¯·ç¡®è®¤:
            
            - [ ] Frontmatter è¯­æ³•æ­£ç¡®
            - [ ] `topic` å­—æ®µå‡†ç¡®åæ˜ æ–‡ä»¶å†…å®¹
            - [ ] `tags` æ ‡ç­¾ç›¸å…³ä¸”åˆ†ç±»åˆç†
            - [ ] `created` å’Œ `modified` æ—¶é—´æˆ³æ­£ç¡®
            - [ ] åŸå§‹å†…å®¹æœªè¢«ç ´å
            
            ---
            
            ## ç”Ÿæˆä¿¡æ¯
            
            - **æœ€åè§¦å‘æäº¤:** [`${{ github.sha }}`](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
            - **æœ€åæ›´æ–°æ—¶é—´:** ${{ github.event.head_commit.timestamp }}
            
          labels: |
            automated
            documentation
            chore
