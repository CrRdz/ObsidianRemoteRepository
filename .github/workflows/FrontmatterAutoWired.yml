name: Frontmatter AutoWired

on:
  push:
    branches:
      - master
    paths:
      - '**.md'

jobs:
  add-frontmatter:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
      
      - name: Check and merge PR branch
        id: check_branch
        run: |
          # æ£€æŸ¥ PR åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --exit-code --heads origin frontmatter-auto-update > /dev/null 2>&1; then
            echo "branch_exists=true" >> $GITHUB_OUTPUT
            echo "[INFO] Found existing PR branch"
            
            # Fetch PR åˆ†æ”¯
            git fetch origin frontmatter-auto-update:frontmatter-auto-update
            
            # è·å– PR åˆ†æ”¯å·²ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
            PR_MODIFIED_FILES=$(git diff --name-only master frontmatter-auto-update | grep '\.md$' || echo "")
            
            if [ -n "$PR_MODIFIED_FILES" ]; then
              echo "pr_modified_files<<EOF" >> $GITHUB_OUTPUT
              echo "$PR_MODIFIED_FILES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
              
              echo "[INFO] Files already in PR:"
              echo "$PR_MODIFIED_FILES"
              
              # â­ å…³é”®ï¼šåˆ‡æ¢åˆ° PR åˆ†æ”¯å¹¶ merge master çš„æœ€æ–°å†…å®¹
              git checkout frontmatter-auto-update
              echo "[INFO] Checked out PR branch"
              
              # åˆå¹¶ master çš„æœ€æ–°å†…å®¹ï¼ˆä¿ç•™ PR åˆ†æ”¯çš„ frontmatter ä¿®æ”¹ï¼‰
              git merge origin/master -m "chore: merge latest master changes" || {
                echo "[WARN] Merge conflict, using ours strategy for .md files"
                # å¦‚æœæœ‰å†²çªï¼Œ.md æ–‡ä»¶ä¿ç•™ PR åˆ†æ”¯çš„ç‰ˆæœ¬ï¼ˆå·²æœ‰ frontmatterï¼‰
                git checkout --ours '*.md'
                git add -A
                git commit -m "chore: merge latest master changes (resolved conflicts)"
              }
              
              echo "[INFO] Merged master into PR branch"
            else
              echo "[INFO] PR branch has no changes, starting fresh"
              git checkout -b frontmatter-auto-update
            fi
          else
            echo "branch_exists=false" >> $GITHUB_OUTPUT
            echo "[INFO] No existing PR branch, will create new one"
            
            # åˆ›å»ºæ–°åˆ†æ”¯ï¼ˆåŸºäº masterï¼‰
            git checkout -b frontmatter-auto-update
          fi
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install openai
      
      - name: Run Frontmatter AutoWired
        env:
          OPENAI_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PR_MODIFIED_FILES: ${{ steps.check_branch.outputs.pr_modified_files }}
        run: |
          python .github/scripts/frontmatter_autowired.py
      
      - name: Get file info
        id: info
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ä¿®æ”¹
          CHANGED_FILES=$(git diff --name-only | grep '\.md$' || echo "")
          
          if [ -n "$CHANGED_FILES" ]; then
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            FILE_LIST=""
            while IFS= read -r file; do
              FILE_LIST="${FILE_LIST}- \`${file}\`\n"
            done <<< "$CHANGED_FILES"
            
            echo "file_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "[INFO] Changed files:"
            echo "$CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "[INFO] No changes detected"
          fi
      
      - name: Commit and push to PR branch
        if: steps.info.outputs.has_changes == 'true'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add -A
          
          git commit -m "chore: è‡ªåŠ¨æ›´æ–° ${{ steps.info.outputs.file_count }} ä¸ªæ–‡ä»¶çš„ frontmatter

          ç”± Frontmatter AutoWired è‡ªåŠ¨ç”Ÿæˆ"
          
          # Push åˆ° PR åˆ†æ”¯
          git push origin frontmatter-auto-update
          
          echo "[SUCCESS] Pushed changes to PR branch"
      
      - name: Create Pull Request (if not exists)
        if: steps.info.outputs.has_changes == 'true' && steps.check_branch.outputs.branch_exists != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: frontmatter-auto-update
          base: master
          
          title: 'chore: è‡ªåŠ¨æ›´æ–° frontmatter å…ƒæ•°æ®'
          
          body: |
            ## æ¦‚è¿°
            
            æœ¬ PR ä½¿ç”¨ AI è‡ªåŠ¨ä¸º Markdown æ–‡ä»¶ç”Ÿæˆæˆ–æ›´æ–° frontmatter å…ƒæ•°æ®ã€‚
            
            **æ³¨æ„ï¼š** æœ¬ PR é‡‡ç”¨æŒç»­æ›´æ–°æ¨¡å¼ã€‚æ¯æ¬¡å‘ master åˆ†æ”¯æ¨é€æ—¶ï¼Œæ–°çš„å˜æ›´ä¼šè‡ªåŠ¨è¿½åŠ åˆ°æ­¤ PRï¼Œç›´åˆ°åˆå¹¶ä¸ºæ­¢ã€‚
            
            ---
            
            ## æœ¬æ¬¡æ›´æ–°å†…å®¹
            
            **ä¿®æ”¹æ–‡ä»¶æ•°ï¼š** ${{ steps.info.outputs.file_count }}
            
            ${{ steps.info.outputs.file_list }}
            
            ---
            
            ## å®¡é˜…æ£€æŸ¥é¡¹
            
            åˆå¹¶å‰è¯·ç¡®è®¤ï¼š
            
            - [ ] Frontmatter è¯­æ³•æ­£ç¡®
            - [ ] `topic` å­—æ®µå‡†ç¡®åæ˜ æ–‡ä»¶å†…å®¹
            - [ ] `tags` æ ‡ç­¾ç›¸å…³ä¸”åˆ†ç±»åˆç†
            - [ ] `created` å’Œ `modified` æ—¶é—´æˆ³æ­£ç¡®
            - [ ] åŸå§‹å†…å®¹æœªè¢«ç ´å
            
            ---
            
            ## ä¿®æ”¹ Frontmatter
            
            å¦‚éœ€è°ƒæ•´ç”Ÿæˆçš„å…ƒæ•°æ®ï¼š
            
            1. åˆ‡æ¢åˆ° **Files changed** æ ‡ç­¾é¡µ
            2. ç‚¹å‡»è¦ä¿®æ”¹çš„æ–‡ä»¶
            3. ç‚¹å‡»å³ä¸Šè§’èœå•å›¾æ ‡ï¼ˆâ‹¯ï¼‰å¹¶é€‰æ‹© **Edit file**
            4. å®Œæˆä¿®æ”¹åç›´æ¥æäº¤åˆ°æœ¬ PR
            
            ---
            
            ## ç”Ÿæˆä¿¡æ¯
            
            - **AI æ¨¡å‹ï¼š** DeepSeek Chat
            - **è§¦å‘æ–¹å¼ï¼š** æ¨é€åˆ° master åˆ†æ”¯
            - **è§¦å‘æäº¤ï¼š** [`${{ github.sha }}`](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
            - **æ›´æ–°æ—¶é—´ï¼š** ${{ github.event.head_commit.timestamp }}
            
            ---
            
            ## å·¥ä½œæµç¨‹è¯´æ˜
            
            æœ¬è‡ªåŠ¨åŒ–æµç¨‹çš„å¤„ç†æ­¥éª¤ï¼š
            
            1. æ£€æµ‹ master åˆ†æ”¯ä¸­çš„ Markdown æ–‡ä»¶å˜æ›´
            2. ä½¿ç”¨ AI æå–è¯­ä¹‰åŒ–æ ‡ç­¾å¹¶ç”Ÿæˆ frontmatter
            3. å°†å˜æ›´ç´¯ç§¯åˆ°æœ¬ PR ä¸­ä»¥ä¾¿æ‰¹é‡å®¡é˜…
            4. ä¿ç•™ç°æœ‰æ–‡ä»¶çš„ `created` æ—¶é—´æˆ³
            5. åç»­ç¼–è¾‘æ—¶è‡ªåŠ¨æ›´æ–° `modified` æ—¶é—´æˆ³
            
            å·²åœ¨æœ¬ PR ä¸­å¤„ç†è¿‡çš„æ–‡ä»¶å°†è¢«è·³è¿‡ï¼Œé¿å…é‡å¤å¤„ç†å’Œå†²çªã€‚
            
          labels: |
            automated
            documentation
            chore
      
      - name: Update PR description (if exists)
        if: steps.info.outputs.has_changes == 'true' && steps.check_branch.outputs.branch_exists == 'true'
        run: |
          # è·å– PR å·
          PR_NUMBER=$(gh pr list --head frontmatter-auto-update --json number --jq '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "[INFO] Updating PR #$PR_NUMBER"
            
            # æ·»åŠ è¯„è®ºè¯´æ˜æœ¬æ¬¡æ›´æ–°
            gh pr comment $PR_NUMBER --body "## ğŸ“ è‡ªåŠ¨æ›´æ–°

            **æœ¬æ¬¡ä¿®æ”¹æ–‡ä»¶æ•°ï¼š** ${{ steps.info.outputs.file_count }}

            ${{ steps.info.outputs.file_list }}

            **è§¦å‘æäº¤ï¼š** [\`${{ github.sha }}\`](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
            **æ›´æ–°æ—¶é—´ï¼š** ${{ github.event.head_commit.timestamp }}"
            
            echo "[SUCCESS] Added comment to PR #$PR_NUMBER"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
