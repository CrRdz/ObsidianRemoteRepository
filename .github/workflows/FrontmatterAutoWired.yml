name: Frontmatter AutoWired

on:
  push:
    branches:
      - master
    paths:
      - '**.md'

jobs:
  add-frontmatter:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ğŸ”§ æ–°å¢: åŒæ­¥ auto-update åˆ†æ”¯åˆ°æœ€æ–° master
      - name: Sync auto-update branch with master
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥è¿œç¨‹åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git ls-remote --heads origin frontmatter-auto-update | grep -q frontmatter-auto-update; then
            echo "Branch exists, syncing with master..."
            
            # åˆ‡æ¢åˆ° auto-update åˆ†æ”¯
            git fetch origin frontmatter-auto-update
            git checkout -b frontmatter-auto-update origin/frontmatter-auto-update
            
            # åˆå¹¶æœ€æ–°çš„ master (ä½¿ç”¨ theirs ç­–ç•¥é¿å…å†²çª)
            git merge origin/master --no-edit -X theirs || {
              echo "Merge conflict detected, using master version"
              git checkout --theirs .
              git add .
              git commit -m "chore: sync with master" || true
            }
            
            # æ¨é€æ›´æ–°
            git push origin frontmatter-auto-update
            
            # åˆ‡å› master ç»§ç»­å¤„ç†
            git checkout master
          else
            echo "Branch does not exist, will be created later"
          fi
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install openai
      
      # ğŸ”§ æ–°å¢: è·å– PR ä¸­å·²å¤„ç†çš„æ–‡ä»¶
      - name: Get existing PR files
        id: pr_files
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å¼€æ”¾çš„ PR
          PR_NUMBER=$(gh pr list --head frontmatter-auto-update --base master --state open --json number --jq '.[0].number')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "Found open PR #$PR_NUMBER"
            
            # è·å– PR ä¸­ä¿®æ”¹çš„æ–‡ä»¶
            PR_FILES=$(gh pr view $PR_NUMBER --json files --jq '.files[].path' | grep '\.md$' || echo "")
            
            if [ -n "$PR_FILES" ]; then
              echo "Files already in PR:"
              echo "$PR_FILES" | sed 's/^/  - /'
              
              # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ (å¤šè¡Œå¤„ç†)
              echo "PR_MODIFIED_FILES<<EOF" >> $GITHUB_ENV
              echo "$PR_FILES" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            else
              echo "No files in PR yet"
            fi
          else
            echo "No open PR found"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run Frontmatter AutoWired
        env:
          OPENAI_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python .github/scripts/frontmatter_autowired.py
      
      - name: Get file info
        id: info
        run: |
          # è·å–ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff --name-only | grep '\.md$' || echo "")
          if [ -n "$CHANGED_FILES" ]; then
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨
            FILE_LIST=""
            while IFS= read -r file; do
              FILE_LIST="${FILE_LIST}- \`${file}\`\n"
            done <<< "$CHANGED_FILES"
            
            echo "file_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create or Update Pull Request
        if: steps.info.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: frontmatter-auto-update
          delete-branch: false
          
          commit-message: |
            chore: auto-add frontmatter for ${{ steps.info.outputs.file_count }} file(s)
            
            Generated by Frontmatter AutoWired
            
          title: 'Frontmatter è‡ªåŠ¨æ›´æ–°'
                    
          body: |
            ## æ¦‚è¿°
            
            æœ¬ PR ä½¿ç”¨ AI è‡ªåŠ¨ä¸º Markdown æ–‡ä»¶ç”Ÿæˆæˆ–æ›´æ–° frontmatter å…ƒæ•°æ®ã€‚
            
            **æ³¨æ„:** æœ¬ PR é‡‡ç”¨æŒç»­æ›´æ–°æ¨¡å¼ã€‚æ¯æ¬¡å‘ master åˆ†æ”¯æ¨é€æ—¶,æ–°çš„å˜æ›´ä¼šè‡ªåŠ¨è¿½åŠ åˆ°æ­¤ PR,ç›´åˆ°åˆå¹¶ä¸ºæ­¢ã€‚
            
            ---
            
            ## æœ¬æ¬¡æ›´æ–°å†…å®¹
            
            **ä¿®æ”¹æ–‡ä»¶æ•°:** ${{ steps.info.outputs.file_count }}
            
            ${{ steps.info.outputs.file_list }}
            
            ---
            
            ## å®¡é˜…æ£€æŸ¥é¡¹
            
            åˆå¹¶å‰è¯·ç¡®è®¤:
            
            - [ ] Frontmatter è¯­æ³•æ­£ç¡®
            - [ ] `topic` å­—æ®µå‡†ç¡®åæ˜ æ–‡ä»¶å†…å®¹
            - [ ] `tags` æ ‡ç­¾ç›¸å…³ä¸”åˆ†ç±»åˆç†
            - [ ] `created` å’Œ `modified` æ—¶é—´æˆ³æ­£ç¡®
            - [ ] åŸå§‹å†…å®¹æœªè¢«ç ´å
            
            ---
            
            ## ä¿®æ”¹ Frontmatter
            
            å¦‚éœ€è°ƒæ•´ç”Ÿæˆçš„å…ƒæ•°æ®:
            
            1. åˆ‡æ¢åˆ° **Files changed** æ ‡ç­¾é¡µ
            2. ç‚¹å‡»è¦ä¿®æ”¹çš„æ–‡ä»¶
            3. ç‚¹å‡»å³ä¸Šè§’èœå•å›¾æ ‡(â‹¯)å¹¶é€‰æ‹© **Edit file**
            4. å®Œæˆä¿®æ”¹åç›´æ¥æäº¤åˆ°æœ¬ PR
            
            ---
            
            ## ç”Ÿæˆä¿¡æ¯
            
            - **AI æ¨¡å‹:** DeepSeek Chat
            - **è§¦å‘æ–¹å¼:** æ¨é€åˆ° master åˆ†æ”¯
            - **è§¦å‘æäº¤:** [`${{ github.sha }}`](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
            - **æ›´æ–°æ—¶é—´:** ${{ github.event.head_commit.timestamp }}
            
            ---
            
            ## å·¥ä½œæµç¨‹è¯´æ˜
            
            æœ¬è‡ªåŠ¨åŒ–æµç¨‹çš„å¤„ç†æ­¥éª¤:
            
            1. æ£€æµ‹ master åˆ†æ”¯ä¸­çš„ Markdown æ–‡ä»¶å˜æ›´
            2. åŒæ­¥ `frontmatter-auto-update` åˆ†æ”¯åˆ°æœ€æ–° master
            3. ä½¿ç”¨ AI æå–è¯­ä¹‰åŒ–æ ‡ç­¾å¹¶ç”Ÿæˆ frontmatter
            4. å°†å˜æ›´ç´¯ç§¯åˆ°æœ¬ PR ä¸­ä»¥ä¾¿æ‰¹é‡å®¡é˜…
            5. ä¿ç•™ç°æœ‰æ–‡ä»¶çš„ `created` æ—¶é—´æˆ³
            6. åç»­ç¼–è¾‘æ—¶è‡ªåŠ¨æ›´æ–° `modified` æ—¶é—´æˆ³
            
            å·²åœ¨æœ¬ PR ä¸­å¤„ç†è¿‡çš„æ–‡ä»¶å°†è¢«è·³è¿‡,é¿å…é‡å¤å¤„ç†å’Œå†²çªã€‚
            
          labels: |
            automated
            documentation
            chore
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
