name: Frontmatter AutoWired

on:
  push:
    branches:
      - master
    paths:
      - '**.md'

jobs:
  add-frontmatter:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    # 防止同时运行多个实例导致分支冲突
    concurrency:
      group: frontmatter-auto-update
      cancel-in-progress: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install openai python-frontmatter pyyaml
      
      # 核心修复：将 PR 分支中已有的 frontmatter 改动合并到当前工作区
      - name: Restore PR branch changes
        id: pr_restore
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 检查是否有已打开的 PR
          PR_NUMBER=$(gh pr list --head frontmatter-auto-update --base master --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          if [ -n "$PR_NUMBER" ]; then
            echo "Found open PR #$PR_NUMBER"
            echo "has_existing_pr=true" >> $GITHUB_OUTPUT
            
            # 拉取 PR 分支
            git fetch origin frontmatter-auto-update 2>/dev/null || {
              echo "PR branch not found remotely, treating as new"
              echo "has_existing_pr=false" >> $GITHUB_OUTPUT
              exit 0
            }
            
            # 获取 PR 分支中所有相对于 master 变更的 .md 文件
            PR_FILES=$(git diff --name-only origin/master...origin/frontmatter-auto-update -- '*.md' 2>/dev/null || echo "")
            
            if [ -n "$PR_FILES" ]; then
              echo "Files already processed in PR:"
              echo "$PR_FILES" | sed 's/^/  - /'
              
              # 将 PR 分支中已处理的文件逐个 checkout 到当前工作区
              while IFS= read -r file; do
                if git show "origin/frontmatter-auto-update:$file" > /dev/null 2>&1; then
                  # 确保目录存在
                  mkdir -p "$(dirname "$file")"
                  git show "origin/frontmatter-auto-update:$file" > "$file"
                  echo "  ✓ Restored: $file"
                fi
              done <<< "$PR_FILES"
              
              echo "PR_RESTORED_FILES<<EOF" >> $GITHUB_ENV
              echo "$PR_FILES" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
          else
            echo "No open PR found"
            echo "has_existing_pr=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run Frontmatter AutoWired
        env:
          OPENAI_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PR_RESTORED_FILES: ${{ env.PR_RESTORED_FILES }}
        run: |
          python .github/scripts/frontmatter_autowired.py
      
      - name: Detect all changes
        id: info
        run: |
          # 检测工作区中所有相对于 HEAD 有变更的 .md 文件（包括 PR 恢复的 + 新处理的）
          CHANGED_FILES=$(git diff --name-only HEAD -- '*.md' 2>/dev/null || echo "")
          
          # 也检查未追踪的新文件
          UNTRACKED=$(git ls-files --others --exclude-standard -- '*.md' 2>/dev/null || echo "")
          
          if [ -n "$UNTRACKED" ]; then
            if [ -n "$CHANGED_FILES" ]; then
              CHANGED_FILES=$(printf "%s\n%s" "$CHANGED_FILES" "$UNTRACKED" | sort -u)
            else
              CHANGED_FILES="$UNTRACKED"
            fi
          fi
          
          if [ -n "$CHANGED_FILES" ]; then
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            FILE_LIST=""
            while IFS= read -r file; do
              FILE_LIST="${FILE_LIST}- \`${file}\`\n"
            done <<< "$CHANGED_FILES"
            
            echo "file_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "All changed files ($FILE_COUNT):"
            echo "$CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi
      
      - name: Create or Update Pull Request
        if: steps.info.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: frontmatter-auto-update
          delete-branch: true
          base: master
          
          commit-message: |
            chore: auto-update frontmatter for ${{ steps.info.outputs.file_count }} file(s)
            
            Trigger: ${{ github.sha }}
            
          title: 'Frontmatter 自动更新'
          
          body: |
            ## 概述
            
            本 PR 使用 AI 自动为 Markdown 文件生成或更新 frontmatter 元数据。
            
            **注意:** 本 PR 采用持续更新模式。每次向 master 分支推送 `.md` 文件时，新的变更会自动追加到此 PR。
            
            ---
            
            ## 累计变更文件
            
            **总文件数:** ${{ steps.info.outputs.file_count }}
            
            ${{ steps.info.outputs.file_list }}
            
            ---
            
            ## 审阅检查项
            
            合并前请确认:
            
            - [ ] Frontmatter 语法正确
            - [ ] `topic` 字段准确反映文件内容
            - [ ] `tags` 标签相关且分类合理
            - [ ] `created` 和 `modified` 时间戳正确
            - [ ] 原始内容未被破坏
            
            ---
            
            ## 生成信息
            
            - **最后触发提交:** [`${{ github.sha }}`](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
            - **最后更新时间:** ${{ github.event.head_commit.timestamp }}
            
          labels: |
            automated
            documentation
