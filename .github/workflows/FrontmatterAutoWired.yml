name: Frontmatter AutoWired

on:
  push:
    branches:
      - master
    paths:
      - '**.md'

jobs:
  add-frontmatter:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    # 防止同时运行多个实例导致分支冲突
    concurrency:
      group: frontmatter-auto-update
      cancel-in-progress: false
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install openai python-frontmatter pyyaml
      
      - name: Run Frontmatter AutoWired
        env:
          OPENAI_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python .github/scripts/frontmatter_autowired.py
      
      - name: Detect all changes
        id: info
        run: |
          echo "=== Detecting all changes ==="
          
          CHANGED_FILES=$(git diff --name-only HEAD 2>/dev/null | grep '\.md$' || true)
          UNTRACKED=$(git ls-files --others --exclude-standard 2>/dev/null | grep '\.md$' || true)
          
          if [ -n "$UNTRACKED" ]; then
            if [ -n "$CHANGED_FILES" ]; then
              CHANGED_FILES=$(printf "%s\n%s" "$CHANGED_FILES" "$UNTRACKED" | sort -u)
            else
              CHANGED_FILES="$UNTRACKED"
            fi
          fi
          
          echo "Changed files:"
          echo "${CHANGED_FILES:-(none)}"
          
          if [ -n "$CHANGED_FILES" ]; then
            FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
            echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            FILE_LIST=""
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              FILE_LIST="${FILE_LIST}- \`${file}\`\n"
            done <<< "$CHANGED_FILES"
            
            echo "file_list<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FILE_LIST" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "All changed files ($FILE_COUNT):"
            echo "$CHANGED_FILES"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi
      
      - name: Commit and push to PR branch
        if: steps.info.outputs.has_changes == 'true'
        id: push_changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 1. 保存 Python 脚本修改后的文件
          git add -A '*.md'
          git stash --include-untracked
          
          # 2. 切换到 PR 分支
          BRANCH_EXISTS=$(git ls-remote --heads origin frontmatter-auto-update | wc -l | tr -d ' ')
          
          if [ "$BRANCH_EXISTS" -gt 0 ]; then
            echo "Checking out existing PR branch..."
            git fetch origin frontmatter-auto-update
            git checkout frontmatter-auto-update
            
            git merge origin/master -m "Merge master into frontmatter-auto-update" --no-edit || {
              echo "Auto-merge failed, resolving by keeping master's version for conflicts"
              git checkout --theirs .
              git add .
              git commit -m "Merge master (resolve conflicts with master's version)" --no-edit || true
            }
          else
            echo "Creating new PR branch from master..."
            git checkout -b frontmatter-auto-update origin/master
          fi
          
          # 3. 应用 stash
          git stash pop || {
            echo "Stash pop had conflicts, resolving..."
            git checkout --theirs . 2>/dev/null || true
            git add .
          }
          
          # 4. 提交变更
          git add -A '*.md'
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_new_commit=false" >> $GITHUB_OUTPUT
          else
            CHANGED_COUNT=$(git diff --cached --name-only | grep '\.md$' | wc -l | tr -d ' ')
            git commit -m "chore: auto-add frontmatter for ${CHANGED_COUNT} file(s)" \
                       -m "" \
                       -m "Trigger: ${{ github.sha }}"
            
            git push origin frontmatter-auto-update
            echo "has_new_commit=true" >> $GITHUB_OUTPUT
            echo "Successfully pushed to frontmatter-auto-update branch"
          fi
      
      - name: Create or update PR
        if: steps.info.outputs.has_changes == 'true' && steps.push_changes.outputs.has_new_commit == 'true'
        run: |
          # 检查是否已有 open 的 PR
          EXISTING_PR=$(gh pr list --head frontmatter-auto-update --base master --state open --json number --jq '.[0].number' 2>/dev/null || echo "")
          
          # 获取 PR 分支相对于 master 的所有变更文件
          git fetch origin frontmatter-auto-update 2>/dev/null || true
          ALL_FILES=$(git diff --name-only origin/master...origin/frontmatter-auto-update 2>/dev/null | grep '\.md$' || true)
          TOTAL_COUNT=0
          FILE_LIST=""
          
          if [ -n "$ALL_FILES" ]; then
            TOTAL_COUNT=$(echo "$ALL_FILES" | wc -l | tr -d ' ')
            while IFS= read -r file; do
              [ -z "$file" ] && continue
              FILE_LIST="${FILE_LIST}- \`${file}\`
          "
            done <<< "$ALL_FILES"
          fi
          
          # 生成 PR body 到临时文件
          # 注意：heredoc 结束标记必须在行首，不能有缩进
          cat > /tmp/pr_body.md <<EOF_BODY
          ## 概述

          本 PR 使用 AI 自动为 Markdown 文件生成或更新 frontmatter 元数据。

          **注意:** 本 PR 采用持续更新模式。每次向 master 分支推送 \`.md\` 文件时，新的变更会自动追加到此 PR。

          ---

          ## 累计变更文件

          **总文件数:** ${TOTAL_COUNT}

          ${FILE_LIST}

          ---

          ## 审阅检查项

          合并前请确认:

          - [ ] Frontmatter 语法正确
          - [ ] \`topic\` 字段准确反映文件内容
          - [ ] \`tags\` 标签相关且分类合理
          - [ ] \`created\` 和 \`modified\` 时间戳正确
          - [ ] 原始内容未被破坏

          ---

          ## 生成信息

          - **最后触发提交:** [\`${{ github.sha }}\`](${{ github.event.repository.html_url }}/commit/${{ github.sha }})
          - **最后更新时间:** ${{ github.event.head_commit.timestamp }}
          EOF_BODY
          
          if [ -n "$EXISTING_PR" ]; then
            echo "Updating existing PR #$EXISTING_PR..."
            gh pr edit "$EXISTING_PR" --body-file /tmp/pr_body.md
            echo "Updated PR #$EXISTING_PR"
          else
            echo "Creating new PR..."
            gh pr create \
              --head frontmatter-auto-update \
              --base master \
              --title "Frontmatter 自动更新" \
              --body-file /tmp/pr_body.md \
              --label "automated" \
              --label "documentation"
            echo "Created new PR"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
