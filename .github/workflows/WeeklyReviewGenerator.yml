name: Weekly Review Generator

on:
  schedule:
    - cron: '0 15 * * 0'  # æ¯å‘¨æ—¥ UTC 15:00ï¼ˆåŒ—äº¬æ—¶é—´ 23:00ï¼‰
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  generate-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write  # æ·»åŠ  PR æƒé™
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Install dependencies
        run: |
          pip install openai
          
      - name: Generate weekly review
        id: generate  
        env:
          OPENAI_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python .github/scripts/generate_weekly_review.py
          
          # æå–ç”Ÿæˆçš„å‘¨æŠ¥ä¿¡æ¯
          WEEK_FILE=$(ls Reviews/Weekly/Weekly-Review-*.md 2>/dev/null | tail -1)
          if [ -n "$WEEK_FILE" ]; then
            WEEK_NUM=$(basename "$WEEK_FILE" | grep -oP 'W\d+')
            echo "week_num=$WEEK_NUM" >> $GITHUB_OUTPUT
            echo "week_file=$WEEK_FILE" >> $GITHUB_OUTPUT
            echo "has_review=true" >> $GITHUB_OUTPUT
          else
            echo "has_review=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Pull Request
        if: steps.generate.outputs.has_review == 'true'  # åªåœ¨æœ‰å‘¨æŠ¥æ—¶åˆ›å»º PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          branch: weekly-review-${{ steps.generate.outputs.week_num }}
          delete-branch: true
          
          commit-message: |
            docs: add weekly review ${{ steps.generate.outputs.week_num }}
            
            Auto-generated by DeepSeek AI
            
          title: 'ğŸ“… Weekly Review ${{ steps.generate.outputs.week_num }}'
          
          body: |
            ## ğŸ“Š æœ¬å‘¨å­¦ä¹ å‘¨æŠ¥
            
            æœ¬ PR ç”± AI è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
            
            - ğŸ“… **å‘¨æŠ¥æ–‡ä»¶**: `${{ steps.generate.outputs.week_file }}`
            - ğŸ¤– **ç”Ÿæˆæ¨¡å‹**: DeepSeek Chat
            - â° **ç”Ÿæˆæ—¶é—´**: ${{ github.event.repository.updated_at }}
            
            ---
            
            ## âœ… åˆå¹¶å‰æ£€æŸ¥æ¸…å•
            
            è¯·åœ¨åˆå¹¶å‰ç¡®è®¤ï¼š
            
            - [ ] å‘¨æŠ¥å†…å®¹å‡†ç¡®æ— è¯¯
            - [ ] æ ¼å¼æ’ç‰ˆæ­£å¸¸
            - [ ] ä¸“ä¸šæœ¯è¯­ä½¿ç”¨æ­£ç¡®
            - [ ] æ²¡æœ‰æ•æ„Ÿä¿¡æ¯
            
            ---
            
            ## ğŸ“ å¦‚ä½•ä¿®æ”¹
            
            å¦‚æœéœ€è¦ä¿®æ”¹å†…å®¹ï¼š
            
            1. åœ¨æœ¬ PR çš„ **Files changed** æ ‡ç­¾é¡µä¸­ç‚¹å‡»æ–‡ä»¶
            2. ç‚¹å‡»å³ä¸Šè§’çš„ **â‹¯** æŒ‰é’®ï¼Œé€‰æ‹© **Edit file**
            3. ä¿®æ”¹åç‚¹å‡» **Commit changes**
            4. ä¿®æ”¹ä¼šè‡ªåŠ¨æ·»åŠ åˆ°æœ¬ PR
            
            ---
            
            ## ğŸ”€ åˆå¹¶æ–¹å¼
            
            - **Squash and merge** (æ¨è): åˆå¹¶ä¸ºä¸€ä¸ª commit
            - **Merge commit**: ä¿ç•™å®Œæ•´å†å²
            
            æ»¡æ„åç‚¹å‡» **Merge pull request** å³å¯ï¼
            
          labels: |
            documentation
            ai-generated
            weekly-review
