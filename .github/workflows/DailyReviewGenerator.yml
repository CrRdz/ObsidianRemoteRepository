name: Daily Review Generator

on:
  workflow_dispatch:
    inputs:
      target_date:
        description: 'ç”Ÿæˆæ—¥æŠ¥çš„æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD, ç•™ç©ºåˆ™ç”Ÿæˆä»Šå¤©)'
        required: false
        default: ''
        type: string
      days_ago:
        description: 'æˆ–é€‰æ‹©å‡ å¤©å‰ (0=ä»Šå¤©, 1=æ˜¨å¤©, ä¼˜å…ˆä½¿ç”¨æ—¥æœŸ)'
        required: false
        default: '0'
        type: choice
        options:
          - '0'
          - '1'
          - '2'
          - '3'
          - '7'

jobs:
  generate-daily-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          
      - name: Install dependencies
        run: |
          pip install openai
      
      - name: Calculate target date
        id: calc_date
        run: |
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DAYS_AGO="${{ github.event.inputs.days_ago || '0' }}"
          
          # å¦‚æœæŒ‡å®šäº†æ—¥æœŸï¼Œä½¿ç”¨æ—¥æœŸï¼›å¦åˆ™è®¡ç®—
          if [ -n "$TARGET_DATE" ]; then
            EXPECTED_DATE="$TARGET_DATE"
          else
            # æ ¹æ® days_ago è®¡ç®—æ—¥æœŸ
            EXPECTED_DATE=$(date -d "$DAYS_AGO days ago" '+%Y-%m-%d' 2>/dev/null || date -v-${DAYS_AGO}d '+%Y-%m-%d')
          fi
          
          echo "expected_date=$EXPECTED_DATE" >> $GITHUB_OUTPUT
          echo "ğŸ“… Expected date: $EXPECTED_DATE"
          
      - name: Generate daily review
        id: generate
        env:
          OPENAI_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          TARGET_DATE="${{ github.event.inputs.target_date }}"
          DAYS_AGO="${{ github.event.inputs.days_ago || '0' }}"
          
          # å¦‚æœæŒ‡å®šäº†æ—¥æœŸï¼Œä½¿ç”¨æ—¥æœŸï¼›å¦åˆ™ä½¿ç”¨ days_ago
          if [ -n "$TARGET_DATE" ]; then
            python .github/scripts/generate_daily_review.py --date "$TARGET_DATE"
          else
            python .github/scripts/generate_daily_review.py $DAYS_AGO
          fi
          
          # ä½¿ç”¨é¢„æœŸçš„æ—¥æœŸæ¥æŸ¥æ‰¾æ–‡ä»¶
          EXPECTED_DATE="${{ steps.calc_date.outputs.expected_date }}"
          DAILY_FILE="Reviews/Daily/Daily-${EXPECTED_DATE}.md"
          
          echo "ğŸ” Looking for: $DAILY_FILE"
          
          if [ -f "$DAILY_FILE" ]; then
            echo "âœ… Found: $DAILY_FILE"
            echo "date_str=$EXPECTED_DATE" >> $GITHUB_OUTPUT
            echo "daily_file=$DAILY_FILE" >> $GITHUB_OUTPUT
            echo "has_review=true" >> $GITHUB_OUTPUT
            
            # ç”ŸæˆåŒ—äº¬æ—¶é—´
            GENERATED_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')
            echo "generated_time=$GENERATED_TIME" >> $GITHUB_OUTPUT
            
            # æå–ä¸»é¢˜åˆ—è¡¨
            TOPICS=$(grep -oP '(?<=topics: \[).*(?=\])' "$DAILY_FILE" || echo "N/A")
            echo "topics=$TOPICS" >> $GITHUB_OUTPUT
          else
            echo "âŒ File not found: $DAILY_FILE"
            echo "ğŸ“‹ Available files:"
            ls -la Reviews/Daily/ || echo "No files found"
            echo "has_review=false" >> $GITHUB_OUTPUT
            echo "::warning::No review generated for $EXPECTED_DATE. The file was not created."
          fi
          
      - name: Create Pull Request
        if: steps.generate.outputs.has_review == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          branch: daily-review-${{ steps.generate.outputs.date_str }}
          delete-branch: true
          
          commit-message: |
            docs: add daily review ${{ steps.generate.outputs.date_str }}
            
            Auto-generated by DeepSeek AI
            
          title: 'ğŸ“ Daily Review ${{ steps.generate.outputs.date_str }}'
          
          body: |
            ## ğŸ“Š ä»Šæ—¥å­¦ä¹ æ—¥æŠ¥
            
            æœ¬ PR ç”± AI è‡ªåŠ¨ç”Ÿæˆï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
            
            - ğŸ“… **æ—¥æŠ¥æ—¥æœŸ**: ${{ steps.generate.outputs.date_str }}
            - ğŸ“„ **æ—¥æŠ¥æ–‡ä»¶**: `${{ steps.generate.outputs.daily_file }}`
            - ğŸ“š **å­¦ä¹ ä¸»é¢˜**: ${{ steps.generate.outputs.topics }}
            - ğŸ¤– **ç”Ÿæˆæ¨¡å‹**: DeepSeek Chat
            - â° **ç”Ÿæˆæ—¶é—´**: ${{ steps.generate.outputs.generated_time }} (UTC+8)
            
            ---
            
            ## âœ… åˆå¹¶å‰æ£€æŸ¥æ¸…å•
            
            è¯·åœ¨åˆå¹¶å‰ç¡®è®¤ï¼š
            
            - [ ] æ—¥æŠ¥å†…å®¹å‡†ç¡®æ— è¯¯
            - [ ] æ ¼å¼æ’ç‰ˆæ­£å¸¸
            - [ ] ä¸“ä¸šæœ¯è¯­ä½¿ç”¨æ­£ç¡®
            - [ ] æ²¡æœ‰æ•æ„Ÿä¿¡æ¯
            
            ---
            
            ## ğŸ“ å¦‚ä½•ä¿®æ”¹
            
            å¦‚æœéœ€è¦ä¿®æ”¹å†…å®¹ï¼š
            
            1. åœ¨æœ¬ PR çš„ **Files changed** æ ‡ç­¾é¡µä¸­ç‚¹å‡»æ–‡ä»¶
            2. ç‚¹å‡»å³ä¸Šè§’çš„ **â‹¯** æŒ‰é’®ï¼Œé€‰æ‹© **Edit file**
            3. ä¿®æ”¹åç‚¹å‡» **Commit changes**
            4. ä¿®æ”¹ä¼šè‡ªåŠ¨æ·»åŠ åˆ°æœ¬ PR
            
            ---
            
            ## ğŸ”€ åˆå¹¶æ–¹å¼
            
            - **Squash and merge** (æ¨è): åˆå¹¶ä¸ºä¸€ä¸ª commit
            - **Merge commit**: ä¿ç•™å®Œæ•´å†å²
            
            æ»¡æ„åç‚¹å‡» **Merge pull request** å³å¯ï¼
            
          labels: |
            documentation
            ai-generated
            daily-review
      
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.generate.outputs.has_review }}" == "true" ]; then
            echo "âœ… Daily review generated successfully"
            echo "ğŸ“‚ File: ${{ steps.generate.outputs.daily_file }}"
            echo "ğŸ“… Date: ${{ steps.generate.outputs.date_str }}"
          else
            echo "ğŸ“ No notes found for ${{ steps.calc_date.outputs.expected_date }} - skipped"
            echo "ğŸ’¡ Try a different date or check your commit history"
          fi
