name: Sync Config to Template Branch

on:
  # 允许在 GitHub 网页上手动点击按钮触发（专门用来首次初始化或强制同步）
  workflow_dispatch: 

  push:
    branches:
      - master
    paths:
      - '.obsidian/**'
      - 'Readme.md'
      - 'LICENSE'
      - '.github/workflows/sync-template.yml'

jobs:
  update-template:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Sync content to template branch
        run: |
          # 1. 切换到 template 分支 (如果不存在则创建孤儿分支)
          if git rev-parse --verify template >/dev/null 2>&1; then
            git checkout template
          else
            git checkout --orphan template
            git rm -rf .
          fi

          # 2. 彻底清理当前 template 分支的所有文件 确保如果 master 删除了某个插件，template 也会同步删除
          # find 命令会保留 .git 目录，删除其他所有文件和文件夹
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

          # 3. 从 master 分支检出你需要的特定文件/文件夹 只抓取以下三项：
          git checkout master -- .obsidian Readme.md LICENSE

          # 4. 重新生成 .gitignore
          # 忽略所有笔记文件和包管理文件，保持模版纯净
          echo "*.md" > .gitignore
          echo "!Readme.md" >> .gitignore  # 排除 Readme.md，让它被保留
          echo "package-lock.json" >> .gitignore # 忽略这个文件
          echo "Asserts/" >> .gitignore          # 忽略附件文件夹

          # 5. 提交并推送
          git add .
          
          if git diff --staged --quiet; then
            echo "配置没有变化，无需提交。"
          else
            git commit -m "Auto-sync: 更新 .obsidian 配置与 Readme"
            git push origin template
          fi
