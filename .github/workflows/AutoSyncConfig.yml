name: Sync Config to Template Branch

on:
  workflow_dispatch: 
  push:
    branches:
      - master
    paths:
      - '.obsidian/**'
      - 'Readme.md'
      - 'LICENSE'
      - 'Assets/**'   
      - '.github/workflows/sync-template.yml'

jobs:
  update-template:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Sync content to template branch
        run: |
          # 1. 切换/创建 template 分支
          if git rev-parse --verify template >/dev/null 2>&1; then
            git checkout template
          else
            git checkout --orphan template
            git rm -rf .
          fi

          # 2. 清理旧文件
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +

          # 3. 从 master 检出内容
          git checkout master -- .obsidian Readme.md LICENSE Assets

          # 4. 生成 .gitignore
          echo "*.md" > .gitignore
          echo "!Readme.md" >> .gitignore
          echo "package-lock.json" >> .gitignore

          # 5. 提交并生成动态 Commit Message
          git add .
          
          # 检查是否有文件变化
          if git diff --staged --quiet; then
            echo "配置没有变化，无需提交。"
          else
            
            # 获取所有变更的文件列表
            FILES=$(git diff --staged --name-only)
            
            # 提取变更的顶层目录或文件作为标题 (例如: .obsidian, Readme.md)
            # 逻辑：取路径第一段 -> 去重 -> 用逗号连接
            SUMMARY=$(echo "$FILES" | cut -d/ -f1 | sort -u | paste -sd ", " -)
            
            # 提交：
            # -m 第一行是标题 (Subject)
            # -m 第二行及之后是详细列表 (Body)
            git commit -m "Auto-sync: 更新 $SUMMARY" -m "涉及的具体文件变动：
            $FILES"
            
            git push origin template --force
          fi
